---
import { LOOPS_COOKIE, LOOPS_LIST_ID } from "astro:env/server";
import { withCommas } from "@util";
const placeholderAudienceCount = 1506;

async function getAudienceCount() {
  if (!LOOPS_COOKIE || !LOOPS_LIST_ID) {
    console.warn(
      "No LOOPS_COOKIE or LOOPS_LIST_ID found. Using placeholder audience count."
    );
    return placeholderAudienceCount;
  }
  try {
    const body = {
      json: {
        filter: null,
        subscribedToTeam: false,
        subscribedToList: true,
        mailingListId: LOOPS_LIST_ID,
        direction: "forward",
      },
    };
    const response = await fetch(
      `https://app.loops.so/api/trpc/emailMessages.streamAudienceCount?input=${encodeURIComponent(JSON.stringify(body))}`,
      {
        headers: {
          "content-type": "application/json",
          cookie: LOOPS_COOKIE,
        },
      }
    );
    const data = await response.json();
    return data.result.data.json.count as number;
  } catch (error) {
    console.error("Error fetching audience count:", error);
    return placeholderAudienceCount;
  }
}
const audienceCount = await getAudienceCount();
---

<span>{withCommas(audienceCount)}</span>
